# FluentBit Helm values
controller:
  env:
    - name: OPENSEARCH_PASS
      valueFrom:
        secretKeyRef:
          name: opensearch-admin-secret
          key: password

daemonset:
  enabled: true
  # Remove hostNetwork - not needed and creates security risks
  
service:
  type: ClusterIP

resources:
  limits:
    cpu: 200m
    memory: 200Mi
  requests:
    cpu: 100m
    memory: 100Mi

volumeMounts:
  - name: varlog
    mountPath: /var/log
    readOnly: true
  - name: containerd
    mountPath: /var/lib/containerd
    readOnly: true

volumes:
  - name: varlog
    hostPath:
      path: /var/log
  - name: containerd
    hostPath:
      path: /var/lib/containerd

config:
  inputs: |
    [INPUT]
        Name                tail
        Tag                 kube.*
        Path                /var/log/containers/*.log
        Parser              cri
        DB                  /var/log/flb_kube.db
        Mem_Buf_Limit       50MB
        Skip_Long_Lines     On
        Refresh_Interval    10
        Rotate_Wait         30

  filters: |
    [FILTER]
        Name                kubernetes
        Match               kube.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
        Kube_Tag_Prefix     kube.var.log.containers.
        Merge_Log           On
        Merge_Log_Key       log_processed
        K8S-Logging.Parser  On
        K8S-Logging.Exclude On
        Annotations         Off
        Labels              On

  outputs: |
    [OUTPUT]
        Name                opensearch
        Match               *
        Host                opensearch-cluster-master.opensearch.svc.cluster.local
        Port                9200
        Index               kubernetes-logs-%Y.%m.%d
        Type                _doc
        Replace_Dots        On
        Retry_Limit         3
        HTTP_User           admin
        HTTP_passwd         ${OPENSEARCH_PASS}
        tls                 On
        tls.verify          Off
        Suppress_Type_Name  On
        Time_Key            @timestamp
        Time_Key_Format     %Y-%m-%dT%H:%M:%S.%L%z
