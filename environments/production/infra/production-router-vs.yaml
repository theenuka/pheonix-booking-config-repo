apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: phoenix-prod-router
  namespace: phoenix-prod
spec:
  hosts:
    - "*"
  gateways:
    - istio-ingress/phoenix-prod-gateway
  http:
    # Auth/identity
    - match:
        - uri:
            prefix: /api/auth
        - uri:
            prefix: /api/users
      route:
        - destination:
            host: identity-service.phoenix-prod.svc.cluster.local
            port:
              number: 7102

    # Hotel service
    - match:
        - uri:
            prefix: /api/hotels
        - uri:
            prefix: /api/my-hotels
      route:
        - destination:
            host: hotel-service.phoenix-prod.svc.cluster.local
            port:
              number: 7103

    # Booking service
    - match:
        - uri:
            prefix: /api/bookings
        - uri:
            prefix: /api/my-bookings
        - uri:
            prefix: /api/my-facility-bookings
        - uri:
            regex: "/api/hotels/.*/bookings"
        - uri:
            regex: "/api/hotels/.*/waitlist"
      route:
        - destination:
            host: booking-service.phoenix-prod.svc.cluster.local
            port:
              number: 7104

    # Search service
    - match:
        - uri:
            prefix: /api/hotels/search
        - uri:
            prefix: /api/search
      route:
        - destination:
            host: search-service.phoenix-prod.svc.cluster.local
            port:
              number: 7105

    # Notification service
    - match:
        - uri:
            prefix: /api/notifications
        - uri:
            prefix: /api/push
      route:
        - destination:
            host: notification-service.phoenix-prod.svc.cluster.local
            port:
              number: 7101

    # Frontend catch-all
    - match:
        - uri:
            prefix: /
      route:
        - destination:
            host: frontend.phoenix-prod.svc.cluster.local
            port:
              number: 80
