global:
  namespace: phoenix-app
  partOf: hotel-reservation
  namespaceLabels:
    istio-injection: enabled
    goldilocks.fairwinds.com/enabled: "true"
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
  namespaceAnnotations:
    configmanagement.gke.io/cluster-selector: phoenix-app
  podLabels:
    goldilocks.fairwinds.com/enabled: "true"
  podAnnotations:
    sidecar.istio.io/inject: "true"
    prometheus.io/scrape: "true"
    prometheus.io/path: "/metrics"
    fluentbit.io/parser: json
  securityContext:
    runAsUser: 1000
    runAsGroup: 3000
    fsGroup: 2000
    runAsNonRoot: true
  otel:
    enabled: true
    endpoint: http://otel-collector.observability:4317
    resourceAttributes: service.namespace=phoenix-app,deployment.environment=prod

asgardeoConfig:
  name: asgardeo-config
  data:
    ASGARDEO_TENANT_DOMAIN: "theenukagranex"
    ASGARDEO_CLIENT_ID: "iYcA_MO8LwTND_hvunAg8VvBHDua"
    ASGARDEO_ORG_URL: "https://api.asgardeo.io/t/theenukagranex"
    ASGARDEO_ISSUER: "https://api.asgardeo.io/t/theenukagranex/oauth2/token"
    ASGARDEO_JWKS_URL: "https://api.asgardeo.io/t/theenukagranex/oauth2/jwks"
    runtime-config.js: |
      (function () {
        console.log("Runtime config loading (Hardcoded)...");

        const fixedOrigin = "http://phoenix-alb-1908878835.us-east-1.elb.amazonaws.com";

        window.__ASGARDEO_CONFIG = {
          signInRedirectURL: fixedOrigin + "/sign-in",
          signOutRedirectURL: fixedOrigin + "/",
          clientID: "iYcA_MO8LwTND_hvunAg8VvBHDua",
          baseUrl: "https://api.asgardeo.io/t/theenukagranex",
          scope: ["openid", "profile", "email"],
          apiBaseUrl: fixedOrigin
        };
        console.log("Runtime config set:", window.__ASGARDEO_CONFIG);
      })();

mongodb:
  name: mongodb
  image: mongo:6.0
  replicas: 1
  storage: 5Gi
  probes:
    livenessPort: 27017
    readinessCommand:
      - mongosh
      - --quiet
      - --eval
      - db.runCommand({ ping: 1 })
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi

resources:
  defaultRequests:
    cpu: 100m
    memory: 128Mi
  defaultLimits:
    cpu: 500m
    memory: 512Mi

services:
  identity:
    name: identity-service
    image: ttl.sh/phoenix-hotel-identity-service-v1:2h
    imagePullPolicy: IfNotPresent
    replicas: 1
    containerPort: 7102
    service:
      port: 80
      portName: http
      type: ClusterIP
    envFromConfigMaps:
      - asgardeo-config
    env:
      - name: MONGODB_CONNECTION_STRING
        value: mongodb://mongodb:27017/hotel-booking
      - name: JWT_SECRET_KEY
        value: my-super-secret-key-change-this-later
      - name: LOG_LEVEL
        value: info
    probes:
      type: tcp
    annotations:
      prometheus.io/port: "7102"
    hpa:
      enabled: true
      minReplicas: 1
      maxReplicas: 5
      targetCPU: 70
      behavior:
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
            - type: Percent
              value: 100
              periodSeconds: 60
        scaleDown:
          stabilizationWindowSeconds: 60
          policies:
            - type: Percent
              value: 50
              periodSeconds: 60
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

  hotel:
    name: hotel-service
    image: ttl.sh/phoenix-hotel-hotel-service-v1:2h
    replicas: 1
    containerPort: 7103
    service:
      port: 80
      portName: http
      type: ClusterIP
    envFromConfigMaps:
      - asgardeo-config
    env:
      - name: MONGODB_CONNECTION_STRING
        value: mongodb://mongodb:27017/hotel-booking
    probes:
      type: tcp
    annotations:
      prometheus.io/port: "7103"
    hpa:
      enabled: true
      minReplicas: 1
      maxReplicas: 5
      targetCPU: 70
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

  booking:
    name: booking-service
    image: ttl.sh/phoenix-hotel-booking-service-v1:2h
    replicas: 1
    containerPort: 7104
    service:
      port: 80
      portName: http
      type: ClusterIP
    envFromConfigMaps:
      - asgardeo-config
    env:
      - name: MONGODB_CONNECTION_STRING
        value: mongodb://mongodb:27017/hotel-booking
    probes:
      type: tcp
    annotations:
      prometheus.io/port: "7104"
    hpa:
      enabled: true
      minReplicas: 1
      maxReplicas: 5
      targetCPU: 70
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

  search:
    name: search-service
    image: ttl.sh/phoenix-hotel-search-service-v1:2h
    replicas: 1
    containerPort: 7105
    service:
      port: 80
      portName: http
      type: ClusterIP
    env:
      - name: MONGODB_CONNECTION_STRING
        value: mongodb://mongodb:27017/hotel-booking
    probes:
      type: tcp
    annotations:
      prometheus.io/port: "7105"
    hpa:
      enabled: true
      minReplicas: 1
      maxReplicas: 5
      targetCPU: 70
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

  notification:
    name: notification-service
    image: ttl.sh/phoenix-hotel-notification-service-v1:2h
    replicas: 1
    containerPort: 7101
    service:
      port: 80
      portName: http
      type: ClusterIP
    probes:
      type: tcp
    annotations:
      prometheus.io/port: "7101"
    hpa:
      enabled: true
      minReplicas: 1
      maxReplicas: 5
      targetCPU: 70
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

  apiGateway:
    name: api-gateway
    image: ttl.sh/phoenix-hotel-api-gateway-v1:2h
    replicas: 1
    containerPort: 7008
    service:
      port: 7008
      portName: http
      type: NodePort
      nodePort: 30000
    envFromConfigMaps:
      - asgardeo-config
    env:
      - name: IDENTITY_SERVICE_URL
        value: http://identity-service
      - name: HOTEL_SERVICE_URL
        value: http://hotel-service
      - name: BOOKING_SERVICE_URL
        value: http://booking-service
      - name: SEARCH_SERVICE_URL
        value: http://search-service
      - name: JWT_SECRET_KEY
        value: my-super-secret-key-change-this-later
    probes:
      type: tcp
    annotations:
      prometheus.io/port: "7008"
    hpa:
      enabled: true
      minReplicas: 1
      maxReplicas: 6
      targetCPU: 65
    resources:
      requests:
        cpu: 150m
        memory: 256Mi
      limits:
        cpu: 700m
        memory: 768Mi

  frontend:
    name: frontend
    image: ttl.sh/phoenix-hotel-frontend-v1:2h
    imagePullPolicy: Always
    replicas: 1
    containerPort: 4173
    service:
      port: 80
      portName: http
      targetPort: 4173
      type: NodePort
      nodePort: 30001
    annotations:
      fluentbit.io/parser: nginx
      prometheus.io/port: "4173"
      prometheus.io/path: "/metrics"
    probes:
      type: http
      path: /
    hpa:
      enabled: true
      minReplicas: 1
      maxReplicas: 5
      targetCPU: 60
    securityContext:
      runAsUser: 101
      runAsGroup: 101
      fsGroup: 101
      runAsNonRoot: true
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
    extraVolumeMounts:
      - name: asgardeo-runtime-config
        mountPath: /usr/share/nginx/html/runtime-config.js
        subPath: runtime-config.js
    extraVolumes:
      - name: asgardeo-runtime-config
        configMap:
          name: asgardeo-config
          items:
            - key: runtime-config.js
              path: runtime-config.js

serviceMonitor:
  enabled: true
  scrapeInterval: 30s
  labels:
    release: monitoring

networkPolicy:
  enabled: true
  allowedNamespaces:
    - istio-ingress
    - monitoring
